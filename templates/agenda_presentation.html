{% extends "base.html" %}

{% block title %}{{ agenda.title }} Sunumu{% endblock %}

{% block content %}
<style>
    body { background: #eef2ff; }
    .navbar { display: none !important; }
    main.container { max-width: 100%; padding: 24px 36px; }
</style>

{% if slides %}
    <div class="presentation-screen" data-total="{{ slides|length }}">
        <div class="presentation-stage">
            <div class="presentation-top-info">
                <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('list_agendas') }}">Gundeme Don</a>
                <span class="presentation-top-info__meta">Toplanti Tarihi: {{ agenda.meeting_date | dateformat }}</span>
            </div>
            {% for slide in slides %}
                {% set slide_index = loop.index0 %}
                <section class="presentation-slide {% if loop.first %}is-active{% endif %}" data-index="{{ loop.index }}">
                    <div class="presentation-columns">
                        <div class="presentation-col presentation-col--left">
                            <div class="presentation-profile">
                                <div class="presentation-avatar">
                                    {% if slide.person.has_profile_photo %}
                                        <img src="{{ url_for('profile_photo_thumb', person_id=slide.person.id) }}" 
                                             alt="{{ slide.person.full_name }}"
                                             loading="lazy">
                                    {% else %}
                                        <div class="presentation-avatar-placeholder">
                                            <span aria-hidden="true">SY</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <h2>{{ slide.person.full_name }}</h2>
                                {% if slide.person.age is not none %}
                                    <div class="presentation-age">
                                        <div class="metric-chip metric-chip--age">
                                            <span class="metric-icon" aria-hidden="true">&#127874;</span>
                                            <span class="metric-value">{{ slide.person.age }}</span>
                                            <span class="metric-suffix">yas</span>
                                        </div>
                                    </div>
                                {% endif %}
                                <div class="presentation-metrics">
                                    <div class="metric-chip" aria-label="Hane Nufusu">
                                        <span class="metric-icon" aria-hidden="true">&#128101;</span>
                                        <span class="metric-value">{{ slide.person.household_size or '-' }}</span>
                                    </div>
                                    <div class="metric-chip" aria-label="Cocuk Sayisi">
                                        <span class="metric-icon" aria-hidden="true">&#129490;</span>
                                        <span class="metric-value">{{ slide.person.children_count or '-' }}</span>
                                    </div>
                                    <div class="metric-chip" aria-label="Ogrenci Sayisi">
                                        <span class="metric-icon" aria-hidden="true">&#127891;</span>
                                        <span class="metric-value">{{ slide.person.student_count or '-' }}</span>
                                    </div>
                                </div>
                                {% if slide.person.spouse_name %}
                                    <div class="presentation-inline-meta">
                                        <span class="inline-meta-icon" aria-hidden="true">&#129309;</span>
                                        <span class="inline-meta-text">{{ slide.person.spouse_name }}</span>
                                    </div>
                                {% endif %}
                                <dl class="presentation-info">
                                    <div>
                                        <dt>Dosya No</dt>
                                        <dd>{{ slide.person.file_no }}</dd>
                                    </div>
                                    <div>
                                        <dt>Adres</dt>
                                        <dd>{{ slide.person.address or '-' }}</dd>
                                    </div>
                                    <div>
                                        <dt>Sosyal Guvence</dt>
                                        <dd>{{ slide.person.social_security or '-' }}</dd>
                                    </div>
                                    <div>
                                        <dt>Engel Durumu</dt>
                                        <dd>
                                            {% if slide.person.disability_status == 'Var' %}
                                                Var {% if slide.person.disability_rate %}({{ slide.person.disability_rate }}){% endif %}
                                            {% elif slide.person.disability_status == 'Yok' %}
                                                Yok
                                            {% else %}
                                                -
                                            {% endif %}
                                        </dd>
                                    </div>
                                </dl>
                                {% if slide.household_images %}
                                    <div class="presentation-gallery" data-gallery="slide-{{ slide_index }}">
                                        <div class="gallery-title">Hane Fotograflari</div>
                                        <div class="gallery-dots">
                                            {% for image in slide.household_images %}
                                                <button
                                                    type="button"
                                                    class="gallery-dot"
                                                    data-gallery="slide-{{ slide_index }}"
                                                    data-index="{{ loop.index0 }}"
                                                    data-image="{{ url_for('household_image_thumb', image_id=image.id) }}"
                                                    data-fullsrc="{{ url_for('household_image', image_id=image.id) }}"
                                                    data-caption="{{ image.filename or 'Hane fotografi' }}"
                                                >
                                                    {{ loop.index }}
                                                </button>
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="presentation-col presentation-col--center">
                            <div class="presentation-panel">
                                <h3><span class="section-icon" aria-hidden="true">&#128221;</span> Basvuru Bilgileri</h3>
                                <div class="presentation-grid">
                                    <div>
                                        <span class="label">Basvuru Tarihi</span>
                                        <span class="value">{{ slide.application_date | dateformat }}</span>
                                    </div>
                                    <div>
                                        <span class="label">Yardim Turu</span>
                                        <span class="value">{{ slide.assistance_type or '-' }}</span>
                                    </div>
                                </div>
                                {% if slide.notes %}
                                    <div class="presentation-notes">
                                        <span class="label">Aciklama</span>
                                        <p>{{ slide.notes }}</p>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="presentation-panel presentation-panel--income">
                                {% set muhtaclik_siniri = 7368.22 %}
                                {% set per_capita_amount = slide.person.per_capita_income %}
                                {% if per_capita_amount is not none %}
                                    {% if per_capita_amount > muhtaclik_siniri %}
                                        {% set per_capita_class = "value income-value--above" %}
                                    {% else %}
                                        {% set per_capita_class = "value income-value--below" %}
                                    {% endif %}
                                {% else %}
                                    {% set per_capita_class = "value" %}
                                {% endif %}
                                <div class="income-header">
                                    <h3><span class="section-icon" aria-hidden="true">&#128176;</span> Mali Durum</h3>
                                    <span class="income-tag">Muhtaclik Siniri: 7.368,22 TL</span>
                                </div>
                                <div class="income-grid">
                                    <div class="income-card">
                                        <span class="label">Hane Geliri</span>
                                        <span class="value">{{ slide.person.household_income | currency }}</span>
                                    </div>
                                    <div class="income-card">
                                        <span class="label">Kisi Basina Gelir</span>
                                        <span class="{{ per_capita_class }}">{{ slide.person.per_capita_income | currency }}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="presentation-panels-grid">
                                <div class="presentation-panel">
                                    <h3><span class="section-icon" aria-hidden="true">&#127873;</span> Son Alinan Yardimlar</h3>
                                    {% if slide.assistance_records %}
                                        <ol class="assistance-list">
                                            {% for item in slide.assistance_records %}
                                                <li>
                                                    <strong>{{ item.assistance_type or 'Yardim' }}</strong>
                                                    <small>
                                                        {% if item.assistance_date %}
                                                            {{ item.assistance_date | dateformat }}
                                                        {% endif %}
                                                        {% if item.assistance_amount is not none %}
                                                            - {{ item.assistance_amount | currency }}
                                                        {% endif %}
                                                    </small>
                                                </li>
                                            {% endfor %}
                                        </ol>
                                    {% else %}
                                        <p class="text-muted mb-0">Kayitli yardim bulunmuyor.</p>
                                    {% endif %}
                                </div>

                                <div class="presentation-panel">
                                    <h3><span class="section-icon" aria-hidden="true">&#127973;</span> Merkezi Yardimlar</h3>
                                    {% if slide.central_assistance %}
                                        <ul class="bullet-list">
                                            {% for central in slide.central_assistance %}
                                                <li>{{ central }}</li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted mb-0">Merkezi yardim kaydi bulunmuyor.</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="presentation-col presentation-col--right">
                            <div class="presentation-panel presentation-panel--description">
                                <h3><span class="section-icon" aria-hidden="true">&#127968;</span> Hane Durumu Aciklamasi</h3>
                                {% set description_lines = slide.person.household_description_lines %}
                                {% if description_lines %}
                                    <div class="description-text description-text--list">
                                        <ul class="description-list">
                                            {% for line in description_lines %}
                                                <li>{{ line }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                {% elif slide.person.household_description %}
                                    <div class="description-text">
                                        {{ slide.person.household_description | trim }}
                                    </div>
                                {% else %}
                                    <p class="text-muted mb-0">Aciklama girilmemis.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </section>
            {% endfor %}
        </div>

        <footer class="presentation-footer">
            <div class="presentation-footer__info">
                <span class="presentation-progress">
                    <span id="presentation-current">1</span> / <span id="presentation-total">{{ slides|length }}</span>
                </span>
                <span class="presentation-footer__title">{{ agenda.title }}</span>
            </div>
            <div class="presentation-footer__controls">
                <button class="btn btn-light border" data-action="prev">Onceki</button>
                <button class="btn btn-primary" data-action="next">Sonraki</button>
            </div>
        </footer>
    </div>

    <div id="image-modal" class="presentation-image-modal" hidden>
        <div class="presentation-image-modal__backdrop" data-dismiss></div>
        <div class="presentation-image-modal__dialog">
            <button class="presentation-image-modal__close" data-dismiss>&times;</button>
            <img src="" alt="" id="presentation-modal-image">
            <p id="presentation-modal-caption"></p>
        </div>
    </div>
{% else %}
    <div class="alert alert-light border shadow-sm" role="alert">
        Bu gundeme ait sunulacak kayit bulunmuyor. Once gundeme kayit ekleyin.
        <a class="btn btn-sm btn-outline-primary ms-2" href="{{ url_for('edit_agenda', agenda_id=agenda.id) }}">Gundemi Duzenle</a>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/presentation.js') }}"></script>
{% endblock %}
