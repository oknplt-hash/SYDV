{% extends "base.html" %}

{% block title %}Kayitlar - Sosyal Yardim{% endblock %}

{% block content %}
<section class="card shadow-sm border-0">
    <div class="card-header py-2 bg-white border-0">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h4 mb-0 d-inline">Kayitli Haneler</h1>
                <span class="badge bg-secondary ms-2">Toplam: {{ total_count }} kayit</span>
            </div>
            <a href="{{ url_for('create_person') }}" class="btn btn-primary">Yeni Kayit</a>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="px-3 py-2 border-bottom bg-light">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label for="search-file-no" class="form-label">Dosya No ile Ara</label>
                    <input type="text" id="search-file-no" class="form-control" placeholder="Dosya numarasi girin"
                        data-search-url="{{ url_for('search_persons') }}">
                </div>
                <div class="col-md-5 col-lg-4">
                    <label for="search-full-name" class="form-label">Ad Soyad ile Ara</label>
                    <input type="text" id="search-full-name" class="form-control" placeholder="Ad soyad girin">
                </div>
                <div class="col-md-3 col-lg-4 text-muted small">
                    Dosya numarasini yazdikca sonuclar otomatik filtrelenir.
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
                <thead class="table-light small">
                    <tr>
                        <th scope="col">Dosya No</th>
                        <th scope="col">Ad Soyad</th>
                        <th scope="col">Telefon</th>
                        <th scope="col">Sosyal Guvence</th>
                        <th scope="col">Olusturulma</th>
                        <th scope="col">Guncelleme</th>
                        <th scope="col" class="text-end">Islemler</th>
                    </tr>
                </thead>
                <tbody id="person-table-body"
                    data-empty-text="Henuz kayit bulunmuyor. Ilk kaydi olusturmak icin ustteki dugmeyi kullanabilirsiniz.">
                    {% if persons %}
                    {% for person in persons %}
                    <tr class="small">
                        <td class="fw-semibold">{{ person.file_no }}</td>
                        <td>{{ person.full_name }}</td>
                        <td>{{ person.phone or "-" }}</td>
                        <td>{{ person.social_security or "-" }}</td>
                        <td>{{ person.created_at | datetimeformat }}</td>
                        <td>{{ person.updated_at | datetimeformat }}</td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-success" data-bs-toggle="modal"
                                    data-bs-target="#addToAgendaModal" data-file-no="{{ person.file_no }}"
                                    data-full-name="{{ person.full_name }}" title="Gundeme Ekle">
                                    <i class="bi bi-calendar-plus"></i> G.Ekle
                                </button>
                                <a href="{{ url_for('edit_person', person_id=person.id) }}"
                                    class="btn btn-outline-secondary">
                                    Duzenle
                                </a>
                                <form method="post" action="{{ url_for('delete_person', person_id=person.id) }}"
                                    onsubmit="return confirm('Kaydi silmek istediginize emin misiniz?');">
                                    <button type="submit" class="btn btn-outline-danger">Sil</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr class="table-empty">
                        <td colspan="7" class="text-center text-muted py-4">
                            Henuz kayit bulunmuyor. Ilk kaydi olusturmak icin ustteki dugmeyi kullanabilirsiniz.
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="card-footer bg-white border-top py-2">
            <div class="d-flex justify-content-between align-items-center">
                <div class="text-muted small">
                    Sayfa {{ page }} / {{ total_pages }} ({{ ((page-1)*per_page)+1 }}-{{ [page*per_page,
                    total_count]|min }} arasi gosteriliyor)
                </div>
                <nav aria-label="Sayfa navigasyonu">
                    <ul class="pagination pagination-sm mb-0">
                        {% if page > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('index', page=1) }}">&laquo; Ilk</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('index', page=page-1) }}">&lsaquo; Onceki</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">&laquo; Ilk</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">&lsaquo; Onceki</span>
                        </li>
                        {% endif %}

                        {% set start_page = [1, page - 2]|max %}
                        {% set end_page = [total_pages, page + 2]|min %}

                        {% for p in range(start_page, end_page + 1) %}
                        {% if p == page %}
                        <li class="page-item active">
                            <span class="page-link">{{ p }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('index', page=p) }}">{{ p }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if page < total_pages %} <li class="page-item">
                            <a class="page-link" href="{{ url_for('index', page=page+1) }}">Sonraki &rsaquo;</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('index', page=total_pages) }}">Son &raquo;</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Sonraki &rsaquo;</span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link">Son &raquo;</span>
                            </li>
                            {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Add to Agenda Modal -->
<div class="modal fade" id="addToAgendaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <form action="{{ url_for('quick_add_to_agenda') }}" method="post" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gundeme Ekle: <span id="modalPersonName" class="fw-bold"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" name="file_no" id="modalFileNo">

                <div class="mb-3">
                    <label for="agendaSelect" class="form-label">Gundem Sec</label>
                    <select class="form-select" id="agendaSelect" name="agenda_id" required>
                        <option value="">Gundem secin...</option>
                        {% for agenda in agendas %}
                        <option value="{{ agenda.id }}">{{ agenda.title }} ({{ agenda.created_at | datetimeformat }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="border-bottom mb-3 pb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <label class="form-label mb-0 fw-semibold">Yardim Kalemleri</label>
                        <button type="button" class="btn btn-sm btn-outline-primary" id="addModalRowBtn">
                            + Kalem Ekle
                        </button>
                    </div>
                </div>

                <div id="modalItemsContainer">
                    <!-- Dynamic rows will be added here -->
                    <div class="row g-2 mb-2 item-row">
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Basvuru Tarihi</label>
                            <input type="date" name="application_date[]" class="form-control form-control-sm">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Yardim Turu</label>
                            <select name="assistance_type[]" class="form-select form-select-sm" required>
                                <option value="">Seciniz...</option>
                                {% for type in assistance_types %}
                                <option value="{{ type }}">{{ type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Notlar</label>
                            <input type="text" name="notes[]" class="form-control form-control-sm"
                                placeholder="Varsa notlar...">
                        </div>
                        <div class="col-md-1 d-flex align-items-end">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-row-btn" disabled>
                                &times;
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Iptal</button>
                <button type="submit" class="btn btn-primary">Kaydet</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var addToAgendaModal = document.getElementById('addToAgendaModal');

        // Auto-select the first (latest) agenda if available
        var agendaSelect = document.getElementById('agendaSelect');
        if (agendaSelect.options.length > 1) {
            agendaSelect.selectedIndex = 1;
        }

        addToAgendaModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var fileNo = button.getAttribute('data-file-no');
            var fullName = button.getAttribute('data-full-name');

            var modalFileNo = addToAgendaModal.querySelector('#modalFileNo');
            var modalPersonName = addToAgendaModal.querySelector('#modalPersonName');

            modalFileNo.value = fileNo;
            modalPersonName.textContent = fullName;
        });

        // Dynamic Rows Logic
        var container = document.getElementById('modalItemsContainer');
        var addBtn = document.getElementById('addModalRowBtn');

        // Template for new row (clone the first one)
        var firstRow = container.querySelector('.item-row');
        // Enable remove button on the template if it was disabled

        addBtn.addEventListener('click', function () {
            var newRow = firstRow.cloneNode(true);

            // Clear values
            newRow.querySelectorAll('input, select').forEach(function (input) {
                input.value = '';
            });

            // Enable remove button
            var removeBtn = newRow.querySelector('.remove-row-btn');
            removeBtn.removeAttribute('disabled');
            removeBtn.addEventListener('click', function () {
                newRow.remove();
            });

            container.appendChild(newRow);
        });

        // Existing remove buttons (currently none active for first row, but good practice)
        container.querySelectorAll('.remove-row-btn').forEach(function (btn) {
            btn.addEventListener('click', function (e) {
                if (container.querySelectorAll('.item-row').length > 1) {
                    e.target.closest('.item-row').remove();
                }
            });
        });
    });
</script>

{% endblock %}