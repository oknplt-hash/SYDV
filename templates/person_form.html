{% extends "base.html" %}

{% block title %}{{ person and "Kayıt Düzenle" or "Yeni Kayıt" }} · Sosyal Yardım{% endblock %}

{% block content %}
<form class="needs-validation" method="post" enctype="multipart/form-data" novalidate>
    <section class="card shadow-sm border-0">
        <div class="card-header py-3 bg-white border-0">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div>
                    <h1 class="h4 mb-0">{{ person and "Kayıt Düzenle" or "Yeni Kayıt" }}</h1>
                    <p class="text-muted small mb-0">Tüm alanları mümkün olduğunca eksiksiz doldurmaya çalışın.</p>
                </div>
                <div class="d-flex gap-2">
                    <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">Listeye Dön</a>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="file_no" class="form-label">Dosya No *</label>
                            <div class="input-group">
                                <input
                                    id="file_no"
                                    name="file_no"
                                    type="text"
                                    class="form-control"
                                    required
                                    value="{{ person.file_no if person else '' }}"
                                    data-check-url="{{ url_for('check_file_no') }}"
                                    data-initial="{{ person.file_no if person else '' }}"
                                >
                                <span class="input-group-text" id="file-no-status" title=""></span>
                            </div>
                            <div class="form-text text-danger d-none" id="file-no-feedback">Bu dosya numarası zaten sistemde var.</div>
                        </div>
                        <div class="col-md-8">
                            <label for="full_name" class="form-label">Adı Soyadı *</label>
                            <input id="full_name" name="full_name" type="text" class="form-control" required value="{{ person.full_name if person else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="national_id" class="form-label">Kimlik Numarası</label>
                            <input id="national_id" name="national_id" type="text" class="form-control" value="{{ person.national_id if person else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="birth_date" class="form-label">Doğum Tarihi</label>
                            <input id="birth_date" name="birth_date" type="date" class="form-control" value="{{ person.birth_date if person and person.birth_date else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="spouse_name" class="form-label">Eşinin Adı Soyadı</label>
                            <input id="spouse_name" name="spouse_name" type="text" class="form-control" value="{{ person.spouse_name if person else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="household_size" class="form-label">Hane Nüfusu</label>
                            <input id="household_size" name="household_size" type="number" min="0" class="form-control" value="{{ person.household_size if person and person.household_size is not none else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="children_count" class="form-label">Çocuk Sayısı</label>
                            <input id="children_count" name="children_count" type="number" min="0" class="form-control" value="{{ person.children_count if person and person.children_count is not none else '' }}">
                        </div>
                        <div class="col-md-4">
                            <label for="student_count" class="form-label">Öğrenci Sayısı</label>
                            <input id="student_count" name="student_count" type="number" min="0" class="form-control" value="{{ person.student_count if person and person.student_count is not none else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="household_income" class="form-label">Hane Geliri (TL)</label>
                            <input id="household_income" name="household_income" type="text" class="form-control" placeholder="0,00" value="{{ person.household_income if person and person.household_income is not none else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="per_capita_income" class="form-label">Kişi Başı Gelir (TL)</label>
                            <input id="per_capita_income" name="per_capita_income" type="text" class="form-control" placeholder="0,00" value="{{ person.per_capita_income if person and person.per_capita_income is not none else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="phone" class="form-label">Telefon</label>
                            <input id="phone" name="phone" type="tel" class="form-control" value="{{ person.phone if person else '' }}">
                        </div>
                        <div class="col-md-6">
                            <label for="social_security" class="form-label">Sosyal Güvence</label>
                            <select id="social_security" name="social_security" class="form-select">
                                <option value="">Seçiniz</option>
                                {% for option in social_security_options %}
                                    <option value="{{ option }}" {% if person and person.social_security == option %}selected{% endif %}>{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-12">
                            <label for="address" class="form-label">Adres</label>
                            <textarea id="address" name="address" class="form-control" rows="3">{{ person.address if person else '' }}</textarea>
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="row g-3 align-items-end">
                        <div class="col-md-6">
                            <label for="disability_status" class="form-label">Engel Durumu</label>
                            <select id="disability_status" name="disability_status" class="form-select">
                                <option value="">Seçiniz</option>
                                {% for option in disability_options %}
                                    <option value="{{ option }}" {% if person and person.disability_status == option %}selected{% endif %}>{{ option }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 {% if not person or person.disability_status != 'Var' %}d-none{% endif %}" id="disability-rate-group">
                            <label for="disability_rate" class="form-label">Engel Oranı</label>
                            <input id="disability_rate" name="disability_rate" type="text" class="form-control" placeholder="%40" value="{{ person.disability_rate if person else '' }}">
                        </div>
                    </div>

                    <hr class="my-4">

                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h2 class="h5 mb-1">Alınan Yardımlar</h2>
                            <p class="small text-muted mb-0">Birden fazla yardım ekleyebilirsiniz.</p>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-assistance">Yardım Ekle</button>
                    </div>
                    <div id="assistance-list" class="assistance-list" data-options='{{ assistance_types | tojson | safe }}'>
                        {% if assistance_records %}
                            {% for record in assistance_records %}
                                <div class="row g-2 assistance-item align-items-end">
                                    <div class="col-md-4">
                                        <label class="form-label">Yardım Türü</label>
                                        <select name="assistance_type[]" class="form-select">
                                            <option value="">Seçiniz</option>
                                            {% for option in assistance_types %}
                                                <option value="{{ option }}" {% if record.assistance_type == option %}selected{% endif %}>{{ option }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Yardım Tarihi</label>
                                        <input type="date" name="assistance_date[]" class="form-control" value="{{ record.assistance_date }}">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Yardım Miktarı</label>
                                        <input type="text" name="assistance_amount[]" class="form-control" value="{{ record.assistance_amount if record.assistance_amount is not none else '' }}" placeholder="0.00">
                                    </div>
                                    <div class="col-md-2 text-end">
                                        <button type="button" class="btn btn-light border remove-assistance w-100">Sil</button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="row g-2 assistance-item align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Yardım Türü</label>
                                    <select name="assistance_type[]" class="form-select">
                                        <option value="">Seçiniz</option>
                                        {% for option in assistance_types %}
                                            <option value="{{ option }}">{{ option }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Yardım Tarihi</label>
                                    <input type="date" name="assistance_date[]" class="form-control">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Yardım Miktarı</label>
                                    <input type="text" name="assistance_amount[]" class="form-control" placeholder="0.00">
                                </div>
                                <div class="col-md-2 text-end">
                                    <button type="button" class="btn btn-light border remove-assistance w-100">Sil</button>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <hr class="my-4">

                    <div>
                        <h2 class="h5 mb-2">Merkezi Yardımlar</h2>
                        <div class="row g-2">
                            {% set selected = selected_central if selected_central is defined else [] %}
                            {% for option in central_assistance_options %}
                                <div class="col-md-6">
                                    <div class="form-check form-switch">
                                        <input
                                            class="form-check-input"
                                            type="checkbox"
                                            role="switch"
                                            id="central_{{ loop.index }}"
                                            name="central_assistance"
                                            value="{{ option }}"
                                            {% if option in selected %}checked{% endif %}
                                        >
                                        <label class="form-check-label" for="central_{{ loop.index }}">{{ option }}</label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                    <hr class="my-4">

                    <div>
                        <label for="household_description" class="form-label">Hane Açıklaması</label>
                        <textarea id="household_description" name="household_description" class="form-control" rows="4">{{ person.household_description if person else '' }}</textarea>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h2 class="h6 mb-3">Profil Fotoğrafı</h2>
                            <figure class="text-center mb-3">
                                {% if person and person.profile_photo %}
                                    <img src="{{ url_for('profile_photo', person_id=person.id) }}" class="img-fluid rounded border" alt="Profil fotoğrafı">
                                {% else %}
                                    <div class="placeholder-img rounded d-flex align-items-center justify-content-center text-muted">Fotoğraf yok</div>
                                {% endif %}
                            </figure>
                            <input type="file" name="profile_photo" class="form-control" accept="image/*">
                            <p class="form-text">Yeni fotoğraf yüklerseniz mevcut olanın üzerine yazılır.</p>
                        </div>
                    </div>

                    <div class="card border-0 shadow-sm mt-4">
                        <div class="card-body">
                            <h2 class="h6 mb-3">Hane Fotoğrafları</h2>
                            {% if household_images %}
                                <div class="row g-2 mb-3">
                                    {% for image in household_images %}
                                        <div class="col-6">
                                            <div class="position-relative border rounded overflow-hidden">
                                                <img src="{{ url_for('household_image', image_id=image.id) }}" class="img-fluid" alt="{{ image.filename or 'Hane fotoğrafı' }}">
                                                <div class="form-check form-check-sm px-2 py-1 bg-white position-absolute top-0 start-0 rounded-bottom-end">
                                                    <input class="form-check-input" type="checkbox" value="{{ image.id }}" name="delete_image_ids" id="delete_image_{{ image.id }}">
                                                    <label class="form-check-label small" for="delete_image_{{ image.id }}">Sil</label>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <input type="file" name="household_images" class="form-control" accept="image/*" multiple>
                            <p class="form-text">Birden fazla fotoğraf seçebilirsiniz.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</form>
{% endblock %}
